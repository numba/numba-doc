<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.4. A guide to using @overload &#8212; Numba 0.47.0.dev0+445.g3ee0556-py3.7-linux-x86_64.egg documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/numba-docs.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.5. Registering Extensions with Entry Points" href="entrypoints.html" />
    <link rel="prev" title="6.3. Example: an interval type" href="interval-example.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.47</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">6.4. A guide to using <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code></a><ul>
<li><a class="reference internal" href="#concrete-example">6.4.1. Concrete Example</a></li>
<li><a class="reference internal" href="#implementing-overload-for-numpy-functions">6.4.2. Implementing <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> for NumPy functions</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="interval-example.html" title="Previous Chapter: 6.3. Example: an interval type"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 6.3. Example:...</span>
    </a>
  </li>
  <li>
    <a href="entrypoints.html" title="Next Chapter: 6.5. Registering Extensions with Entry Points"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">6.5. Register... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/extending/overloading-guide.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="a-guide-to-using-overload">
<span id="overloading-guide"></span><h1>6.4. A guide to using <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code><a class="headerlink" href="#a-guide-to-using-overload" title="Permalink to this headline">¶</a></h1>
<p>As mentioned in the <a class="reference internal" href="high-level.html#high-level-extending"><span class="std std-ref">high-level extension API</span></a>, you
can use the <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> decorator to create a Numba implementation of a
function that can be used in <a class="reference internal" href="../glossary.html#term-nopython-mode"><span class="xref std std-term">nopython mode</span></a> functions. A common use case
is to re-implement NumPy functions so that they can be called in <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code>
decorated code. This section discusses how and when to use the <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code>
decorator and what contributing such a function to the Numba code base might
entail. This should help you get started when needing to use the <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code>
decorator or when attempting to contribute new functions to Numba itself.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> decorator and it’s variants are useful when you have a
third-party library that you do not control and you wish to provide Numba
compatible implementations for specific functions from that library.</p>
<div class="section" id="concrete-example">
<h2>6.4.1. Concrete Example<a class="headerlink" href="#concrete-example" title="Permalink to this headline">¶</a></h2>
<p>Let’s assume that you are working on a minimization algorithm that makes use of
<a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.norm.html"><code class="docutils literal notranslate"><span class="pre">scipy.linalg.norm</span></code></a> to find different vector norms and the <a class="reference external" href="https://en.wikipedia.org/wiki/Frobenius_inner_product">frobenius
norm</a> for matrices.
You know that only integer and real numbers will be involved. (While this may
sound like an artificial example, especially because a Numba implementation of
<code class="docutils literal notranslate"><span class="pre">numpy.linalg.norm</span></code> exists, it is largely pedagogical and serves to
illustrate how and when to use <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code>).</p>
<p>The skeleton might look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">algorithm</span><span class="p">():</span>
    <span class="c1"># setup</span>
    <span class="n">v</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># take a step</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
<p>Now, let’s further assume, that you have heard of Numba and you now wish to use
it to accelerate your function. However, after adding the
<code class="docutils literal notranslate"><span class="pre">jit(nopython=True)</span></code>
decorator, Numba complains that <code class="docutils literal notranslate"><span class="pre">scipy.linalg.norm</span></code> isn’t supported. From
looking at the documentation, you realize that a norm is probably fairly easy
to implement using NumPy. A good starting point is the following template.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Declare that function `myfunc` is going to be overloaded (have a</span>
<span class="c1"># substitutable Numba implementation)</span>
<span class="nd">@overload</span><span class="p">(</span><span class="n">myfunc</span><span class="p">)</span>
<span class="c1"># Define the overload function with formal arguments</span>
<span class="c1"># these arguments must be matched in the inner function implementation</span>
<span class="k">def</span> <span class="nf">jit_myfunc</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="c1"># This scope is for typing, access is available to the *type* of all</span>
    <span class="c1"># arguments. This information can be used to change the behaviour of the</span>
    <span class="c1"># implementing function and check that the types are actually supported</span>
    <span class="c1"># by the implementation.</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span> <span class="c1"># this will show the Numba type of arg0</span>

    <span class="c1"># This is the definition of the function that implements the `myfunc` work.</span>
    <span class="c1"># It does whatever algorithm is needed to implement myfunc.</span>
    <span class="k">def</span> <span class="nf">myfunc_impl</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span> <span class="c1"># match arguments to jit_myfunc</span>
        <span class="c1"># &lt; Implementation goes here &gt;</span>
        <span class="k">return</span> <span class="c1"># whatever needs to be returned by the algorithm</span>

    <span class="c1"># return the implementation</span>
    <span class="k">return</span> <span class="n">myfunc_impl</span>
</pre></div>
</div>
<p>After some deliberation and tinkering, you end up with the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="k">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">numba.extending</span> <span class="k">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">register_jitable</span>
<span class="kn">from</span> <span class="nn">numba.errors</span> <span class="k">import</span> <span class="n">TypingError</span>

<span class="kn">import</span> <span class="nn">scipy.linalg</span>


<span class="nd">@register_jitable</span>
<span class="k">def</span> <span class="nf">_oneD_norm_2</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="c1"># re-usable implementation of the 2-norm</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">val</span><span class="p">))</span>


<span class="nd">@overload</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jit_norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Optional</span><span class="p">):</span>
        <span class="nb">ord</span> <span class="o">=</span> <span class="nb">ord</span><span class="o">.</span><span class="n">type</span>
    <span class="c1"># Reject non integer, floating-point or None types for ord</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">NoneType</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">TypingError</span><span class="p">(</span><span class="s2">&quot;&#39;ord&#39; must be either integer or floating-point&quot;</span><span class="p">)</span>
    <span class="c1"># Reject non-ndarray types</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TypingError</span><span class="p">(</span><span class="s2">&quot;Only accepts NumPy ndarray&quot;</span><span class="p">)</span>
    <span class="c1"># Reject ndarrays with non integer or floating-point dtype</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">TypingError</span><span class="p">(</span><span class="s2">&quot;Only integer and floating point types accepted&quot;</span><span class="p">)</span>
    <span class="c1"># Reject ndarrays with unsupported dimensionality</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TypingError</span><span class="p">(</span><span class="s1">&#39;3D and beyond are not allowed&#39;</span><span class="p">)</span>
    <span class="c1"># Implementation for scalars/0d-arrays</span>
    <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="c1"># Implementation for vectors</span>
    <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_oneD_norm_x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">ord</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">ord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_oneD_norm_2</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">ord</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">ord</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">ord</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">ord</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="nb">ord</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="nb">ord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_oneD_norm_x</span>
    <span class="c1"># Implementation for matrices</span>
    <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_two_D_norm_2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_oneD_norm_2</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">_two_D_norm_2</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># simple test function to check that the overload works</span>
        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">ord</span><span class="p">)</span>

    <span class="c1"># spot check for vectors</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">use</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="c1"># spot check for matrices</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">use</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
<p>As you can see, the implementation only supports what you need right now:</p>
<ul class="simple">
<li>Only supports integer and floating-point types</li>
<li>All vector norms</li>
<li>Only the Frobenius norm for matrices</li>
<li>Code sharing between vector and matrix implementations using
<code class="docutils literal notranslate"><span class="pre">&#64;register_jitable</span></code>.</li>
<li>Norms are implemented using NumPy syntax. (This is possible because
Numba is very aware of NumPy and many functions are supported.)</li>
</ul>
<p>So what actually happens here? The <code class="docutils literal notranslate"><span class="pre">overload</span></code> decorator registers a suitable
implementation for <code class="docutils literal notranslate"><span class="pre">scipy.linalg.norm</span></code> in case a call to this is encountered
in code that is being JIT-compiled, for example when you decorate your
<code class="docutils literal notranslate"><span class="pre">algorithm</span></code> function with <code class="docutils literal notranslate"><span class="pre">&#64;jit(nopython=True)</span></code>. In that case, the function
<code class="docutils literal notranslate"><span class="pre">jit_norm</span></code> will be called with the currently encountered types and will then
return either <code class="docutils literal notranslate"><span class="pre">_oneD_norm_x</span></code> in the vector case and <code class="docutils literal notranslate"><span class="pre">_two_D_norm_2</span></code>.</p>
<p>You can download the example code here: <a class="reference download internal" download="" href="../_downloads/fc175826af887ed883a533c8e4443908/mynorm.py"><code class="xref download docutils literal notranslate"><span class="pre">mynorm.py</span></code></a></p>
</div>
<div class="section" id="implementing-overload-for-numpy-functions">
<h2>6.4.2. Implementing <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> for NumPy functions<a class="headerlink" href="#implementing-overload-for-numpy-functions" title="Permalink to this headline">¶</a></h2>
<p>Numba supports NumPy through the provision of <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> compatible
re-implementations of NumPy functions. In such cases <code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> is a very
convenient option for writing such implementations, however there are a few
additional things to watch out for.</p>
<ul class="simple">
<li>The Numba implementation should match the NumPy implementation as closely as
feasible with respect to accepted types, arguments, raised exceptions and
algorithmic complexity (Big-O / Landau order).</li>
<li>When implementing supported argument types, bear in mind that, due to
duck typing, NumPy does tend to accept a multitude of argument types beyond
NumPy arrays such as scalar, list, tuple, set, iterator, generator etc.
You will need to account for that during type inference and subsequently as
part of the tests.</li>
<li>A NumPy function may return a scalar, array or a data structure
which matches one of its inputs, you need to be aware of type
unification problems and dispatch to appropriate implementations. For
example, <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.corrcoef.html"><code class="docutils literal notranslate"><span class="pre">np.corrcoef</span></code></a> may return an array or a scalar depending on its
inputs.</li>
</ul>
<ul>
<li><p class="first">If you are implementing a new function, you should always update the
<a class="reference external" href="http://numba.pydata.org/numba-doc/latest/reference/numpysupported.html">documentation</a>.
The sources can be found in <code class="docutils literal notranslate"><span class="pre">docs/source/reference/numpysupported.rst</span></code>. Be
sure to mention any limitations that your implementation has, e.g. no support
for the <code class="docutils literal notranslate"><span class="pre">axis</span></code> keyword.</p>
</li>
<li><p class="first">When writing tests for the functionality itself, it’s useful to include
handling of non-finite values, arrays with different shapes and layouts,
complex inputs, scalar inputs, inputs with types for which support is not
documented (e.g. a function which the NumPy docs say requires a float or int
input might also ‘work’ if given a bool or complex input).</p>
</li>
<li><p class="first">When writing tests for exceptions, for example if adding tests to
<code class="docutils literal notranslate"><span class="pre">numba/tests/test_np_functions.py</span></code>, you may encounter the following error
message:</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">======================================================================</span>
<span class="n">FAIL</span><span class="p">:</span> <span class="n">test_foo</span> <span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">test_np_functions</span><span class="o">.</span><span class="n">TestNPFunctions</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">&quot;&lt;path&gt;/numba/numba/tests/support.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">645</span><span class="p">,</span> <span class="ow">in</span> <span class="n">tearDown</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memory_leak_teardown</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">&quot;&lt;path&gt;/numba/numba/tests/support.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">619</span><span class="p">,</span> <span class="ow">in</span> <span class="n">memory_leak_teardown</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assert_no_memory_leak</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">&quot;&lt;path&gt;/numba/numba/tests/support.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">628</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_no_memory_leak</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total_alloc</span><span class="p">,</span> <span class="n">total_free</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="mi">36</span> <span class="o">!=</span> <span class="mi">35</span>
</pre></div>
</div>
<p>This occurs because raising exceptions from jitted code leads to reference
leaks. Ideally, you will place all exception testing in a separate test
method and then add a call in each test to <code class="docutils literal notranslate"><span class="pre">self.disable_leak_check()</span></code> to
disable the leak-check (inherit from <code class="docutils literal notranslate"><span class="pre">numba.tests.support.TestCase</span></code> to make
that available).</p>
</li>
<li><p class="first">For many of the functions that are available in NumPy, there are
corresponding methods defined on the NumPy <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> type. For example, the
function <code class="docutils literal notranslate"><span class="pre">repeat</span></code> is available as a NumPy module level function and a
member function on the <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> class.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># function</span>
<span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="c1"># method</span>
<span class="n">a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you have written the function implementation, you can easily use
<code class="docutils literal notranslate"><span class="pre">&#64;overload_method</span></code> and reuse it. Just be sure to check that NumPy doesn’t
diverge in the implementations of its function/method.</p>
<p>As an example, the <code class="docutils literal notranslate"><span class="pre">repeat</span></code> function/method:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@extending</span><span class="o">.</span><span class="n">overload_method</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">array_repeat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">array_repeat_impl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeat</span><span class="p">):</span>
        <span class="c1"># np.repeat has already been overloaded</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array_repeat_impl</span>
</pre></div>
</div>
</li>
<li><p class="first">If you need to create ancillary functions, for example to re-use a small
utility function or to split your implementation across functions for the
sake of readability, you can make use of the <code class="docutils literal notranslate"><span class="pre">&#64;register_jitable</span></code> decorator.
This will make those functions available from within your <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> and
<code class="docutils literal notranslate"><span class="pre">&#64;overload</span></code> decorated functions.</p>
</li>
<li><p class="first">The Numba continuous integration (CI) set up tests a wide variety of NumPy
versions, you’ll sometimes be alerted to a change in behaviour from some
previous NumPy version. If you can find supporting evidence in the NumPy
change log / repository, then you’ll need to decide whether to create
branches and attempt to replicate the logic across versions, or use a version
gate (with associated wording in the documentation) to advertise that Numba
replicates NumPy from some particular version onwards.</p>
</li>
<li><p class="first">You can look at the Numba source code for inspiration, many of the overloaded
NumPy functions and methods are in <code class="docutils literal notranslate"><span class="pre">numba/targets/arrayobj.py</span></code>. Below, you
will find a list of implementations to look at that are well implemented in
terms of accepted types and test coverage.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">np.repeat</span></code></li>
</ul>
</li>
</ul>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>